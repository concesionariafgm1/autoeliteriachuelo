rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isClientOwner(clientId) {
      return request.auth != null
        && request.auth.token.clientId == clientId
        && (request.auth.token.role == null || request.auth.token.role == "admin");
    }

    // Mapeo de dominios a clientIds - lectura pública
    match /domains/{hostname} {
      allow read: if true;
      allow write: if false;
    }

    // Vehículos públicos - readable to all, writable solo con custom claim
    match /clients/{clientId}/vehicles/{vehicleId} {
      allow read: if true;
      allow write: if isClientOwner(clientId);
    }

    // Configuración pública de tenants (estética/settings públicos)

    // Leads (formularios de contacto)
    // - create: permitido sin auth pero validando campos (anti-spam básico)
    // - read/update/delete: solo admins
    match /clients/{clientId}/leads/{leadId} {
      allow create: if
        request.resource.data.keys().hasOnly(['nombre','email','mensaje','page','userAgent','createdAt'])
        && request.resource.data.nombre is string && request.resource.data.nombre.size() >= 2 && request.resource.data.nombre.size() <= 80
        && request.resource.data.email is string && request.resource.data.email.size() >= 6 && request.resource.data.email.size() <= 120
        && request.resource.data.email.matches('^\\S+@\\S+\\.\\S+$')
        && request.resource.data.mensaje is string && request.resource.data.mensaje.size() >= 5 && request.resource.data.mensaje.size() <= 2000
        && (!('page' in request.resource.data) || (request.resource.data.page is string && request.resource.data.page.size() <= 120))
        && (!('userAgent' in request.resource.data) || (request.resource.data.userAgent is string && request.resource.data.userAgent.size() <= 300));
      allow read, update, delete: if isClientOwner(clientId);
    }

    // SOLO el documento "public" es accesible públicamente
    match /clients/{clientId}/settings/public {
      allow read: if true;
      allow write: if isClientOwner(clientId);
    }

    // Configuración privada de tenants (otros settings)
    // Solo el owner del cliente puede leer/escribir
    match /clients/{clientId}/settings/{docId} {
      allow read, write: if docId == "public" || isClientOwner(clientId);
    }

    // Denegar todo lo que no sea específicamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}